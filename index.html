<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>BTC Sim: Asymmetric Liquidity</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    body {
        margin: 0; background: #121417; color: #e6e6e6;
        font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
        overflow-y: auto; min-height: 100vh; padding-bottom: 40px;
        -webkit-tap-highlight-color: transparent;
    }
    .wrapper { max-width: 800px; margin: 0 auto; padding: 10px; box-sizing: border-box; }
    h3 { margin: 15px 0 5px 0; text-align: center; color: #fff; font-weight: 800; letter-spacing: 1px; }
    .sub-title { text-align: center; font-size: 12px; color: #6b7280; margin-bottom: 10px; }

    /* HUD */
    .stats-bar {
        display: flex; justify-content: space-between;
        background: #1e2228; padding: 10px 15px; border-radius: 8px 8px 0 0;
        border: 1px solid #1f2937; border-bottom: none;
        font-family: monospace; font-size: 14px;
    }
    .stat-val { font-weight: 700; color: #fff; }
    .stat-val.usd { color: #1fc77b; }

    /* FLOW */
    .market-flow {
        display: flex; justify-content: space-between;
        background: #16191d; padding: 8px 15px; border-radius: 0 0 8px 8px;
        border: 1px solid #1f2937; border-top: 1px solid #2d333b;
        margin-bottom: 15px; font-family: monospace; font-size: 12px;
    }
    .flow-item { color: #9ca3af; }
    .flow-val { font-weight: 700; }
    .flow-val.buy { color: #1fc77b; }
    .flow-val.sell { color: #e04b4b; }

    .chart-box {
        width: 100%; border: 1px solid #1f2937; background: #121417;
        position: relative; border-radius: 8px; overflow: hidden; margin-bottom: 10px;
    }
    #price { width: 100%; height: 320px; cursor: move; }
    #volume { width: 100%; height: 160px; }

    #controls {
        display: flex; gap: 12px; margin-top: 20px;
        background: #1e2228; padding: 15px; border-radius: 12px; border: 1px solid #1f2937; 
    }
    #amount {
        width: 90px; padding: 12px; font-size: 16px; text-align: center;
        background: #121417; border: 1px solid #374151; color: #fff;
        border-radius: 8px; font-weight: 700; outline: none;
    }
    button {
        flex: 1; padding: 12px; font-size: 16px; font-weight: 800;
        border: none; border-radius: 8px; cursor: pointer; color: #fff;
        transition: transform 0.1s;
    }
    button:active { transform: scale(0.96); }
    .buy { background: #1fc77b; color: #052e16; box-shadow: 0 4px 0 #158f58; }
    .buy:active { box-shadow: 0 0 0 #158f58; transform: translateY(4px); }
    .sell { background: #e04b4b; color: #3f0808; box-shadow: 0 4px 0 #9e3333; }
    .sell:active { box-shadow: 0 0 0 #9e3333; transform: translateY(4px); }
</style>
</head>
<body>

<div class="wrapper">
    <h3>ASYMMETRIC MARKET</h3>
    <div class="sub-title">Thin Ask (Up is Easy) vs Thick Bid (Down is Hard)</div>

    <div class="stats-bar">
        <div>USD: <span class="stat-val usd" id="ui-usd">$1,000,000</span></div>
        <div>BTC: <span class="stat-val" id="ui-btc">1000.00</span></div>
    </div>

    <div class="market-flow">
        <div class="flow-item">Buys: <span class="flow-val buy" id="ui-vol-buy">$0</span></div>
        <div class="flow-item">Sells: <span class="flow-val sell" id="ui-vol-sell">$0</span></div>
    </div>

    <div class="chart-box"><div id="price"></div></div>
    <div class="chart-box"><div id="volume"></div></div>

    <div id="controls">
        <button class="buy" onclick="trade('BUY')">BUY</button>
        <input id="amount" type="number" value="10000" step="1000">
        <button class="sell" onclick="trade('SELL')">SELL</button>
    </div>
</div>

<script>
const TIMEFRAME = 15000;

/* ===== АСИММЕТРИЯ СТАКАНА ===== */
// 1. Сопротивление падению (BID WALL). 
// Высокое значение = нужно много денег, чтобы продавить вниз.
// Это позволяет тебе налить $10,000 красного объема, но цена упадет не так сильно.
const DOWN_RESISTANCE = 2000; 

// 2. Сопротивление росту (ASK WALL).
// Низкое значение = "нет продаж", цена летит вверх от малейшего чиха.
// Это позволяет толпе на $1,000 перебить твое падение и сделать свечу зеленой.
const UP_RESISTANCE = 150; 

let price = 100; 
let balanceUSD = 1_000_000; 
let balanceBTC = 1000; 

let currentCandle = null;
let lastCandleTime = null;
let volBuy = 0;
let volSell = 0;

/* ===== GRAPHICS ===== */
const commonOpts = {
    layout: { background: { color: '#121417' }, textColor: '#9ca3af' },
    grid: { vertLines: { color: '#1f2937', style: 2 }, horzLines: { color: '#1f2937', style: 2 } },
    timeScale: { 
        timeVisible: true, secondsVisible: true, borderColor: '#1f2937',
        barSpacing: 12, minBarSpacing: 2, rightOffset: 10
    },
    handleScroll: { vertTouchDrag: true, horzTouchDrag: true, pressedMouseMove: true },
    kineticScroll: { touch: true, mouse: true }
};

const priceEl = document.getElementById('price');
const priceChart = LightweightCharts.createChart(priceEl, {
    ...commonOpts,
    rightPriceScale: { visible: true, borderColor: '#1f2937', autoScale: true, minimumWidth: 75 },
});
const candleSeries = priceChart.addCandlestickSeries({
    upColor: '#1fc77b', downColor: '#e04b4b', borderUpColor: '#1fc77b', borderDownColor: '#e04b4b', wickUpColor: '#1fc77b', wickDownColor: '#e04b4b'
});

const volumeEl = document.getElementById('volume');
const volumeChart = LightweightCharts.createChart(volumeEl, {
    ...commonOpts,
    rightPriceScale: { visible: true, borderColor: '#1f2937', minimumWidth: 75 }, 
});
const volumeSeries = volumeChart.addHistogramSeries({
    priceFormat: { type: 'volume' }, priceScaleId: 'right',
});

function sync(a, b) {
    const s1 = a.timeScale(), s2 = b.timeScale();
    s1.subscribeVisibleLogicalRangeChange(r => { if(r) s2.setVisibleLogicalRange(r) });
    s2.subscribeVisibleLogicalRangeChange(r => { if(r) s1.setVisibleLogicalRange(r) });
}
sync(priceChart, volumeChart);

function resize() {
    if(priceEl.parentElement) {
        const w = priceEl.parentElement.offsetWidth;
        priceChart.resize(w, 320); volumeChart.resize(w, 160); 
    }
}
window.addEventListener('resize', resize);

/* ===== LOGIC ===== */
const uiUsd = document.getElementById('ui-usd');
const uiBtc = document.getElementById('ui-btc');
const uiVolBuy = document.getElementById('ui-vol-buy');
const uiVolSell = document.getElementById('ui-vol-sell');

function updateUI() {
    uiUsd.innerText = '$' + Math.floor(balanceUSD).toLocaleString('en-US');
    uiBtc.innerText = balanceBTC.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    uiVolBuy.innerText = '$' + Math.floor(volBuy).toLocaleString('en-US');
    uiVolSell.innerText = '$' + Math.floor(volSell).toLocaleString('en-US');
}

function updateCandleHighLowWithNoise(nowPrice) {
    const noise = nowPrice * (0.0001 + Math.random() * 0.0005); 
    const potentialHigh = nowPrice + noise;
    const potentialLow = nowPrice - noise;
    currentCandle.high = Math.max(currentCandle.high, potentialHigh);
    currentCandle.low = Math.min(currentCandle.low, potentialLow);
    currentCandle.close = nowPrice;
}

function startNewCandle(time){
    volBuy = 0; volSell = 0;
    currentCandle = {time, open:price, high:price, low:price, close:price};
    candleSeries.update(currentCandle);
    updateVolume(time);
    updateUI();
}

function updateVolume(time) {
    const delta = volBuy - volSell;
    volumeSeries.update({
        time: time, value: delta, 
        color: delta >= 0 ? '#1fc77b' : '#e04b4b'
    });
}

function ensureCandle(){
    const now = Math.floor(Date.now()/TIMEFRAME)*TIMEFRAME;
    if(!lastCandleTime || now > lastCandleTime){
        startNewCandle(now/1000);
        lastCandleTime = now;
    }
}

function recordTrade(usd, side){
    let deltaPrice = 0;

    if(side === 'BUY'){
        if(balanceUSD < usd) return;
        balanceUSD -= usd; 
        balanceBTC += usd/price;
        volBuy += usd;
        
        // Покупка летит вверх легко (UP_RESISTANCE мал)
        deltaPrice = usd / UP_RESISTANCE;
        price += deltaPrice;
        
    } else {
        const btcNeeded = usd/price;
        if(balanceBTC < btcNeeded) return;
        balanceBTC -= btcNeeded; 
        balanceUSD += usd;
        volSell += usd;

        // Продажа идет туго (DOWN_RESISTANCE велик)
        deltaPrice = usd / DOWN_RESISTANCE;
        price -= deltaPrice;
    }

    updateCandleHighLowWithNoise(price);
    candleSeries.update(currentCandle);
    updateVolume(currentCandle.time);
    updateUI();
}

function trade(side){
    ensureCandle();
    const val = parseFloat(document.getElementById('amount').value);
    if(val > 0) recordTrade(val, side);
}

/* === CROWD LOGIC === */
function crowd(){
    if(Math.random() < 0.1) return; 

    // Толпа покупает совсем чуть-чуть ($100 - $500)
    const amt = 100 + Math.random() * 400; 
    
    // Но так как UP_RESISTANCE (150) в 13 раз меньше DOWN_RESISTANCE (2000),
    // эти $500 толкнут цену сильнее, чем твои $5000 продажи.
    
    const deltaPrice = amt / UP_RESISTANCE;
    price += deltaPrice;
    volBuy += amt;

    updateCandleHighLowWithNoise(price);
    candleSeries.update(currentCandle);
    updateVolume(currentCandle.time);
    updateUI();
}

const start = Math.floor(Date.now()/TIMEFRAME)*TIMEFRAME;
startNewCandle(start/1000);
lastCandleTime = start;
updateUI();
resize();

setInterval(() => {
    ensureCandle();
    crowd();
}, 200);
</script>
</body>
</html>
