<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>BTC/USD Simulator (5s) Â· Price + Net Volume</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
body{
  margin:0;
  background:#111;
  color:#ddd;
  font-family:Arial,sans-serif;
  text-align:center;
}
h3{margin:12px 0}

#price{width:100%;height:320px}
#volume{width:100%;height:100px}

#controls{
  display:flex;
  justify-content:center;
  gap:14px;
  margin:12px 0;
}

#amount{
  width:120px;
  padding:10px;
  font-size:18px;
  text-align:center;
}

button{
  padding:12px 22px;
  font-size:20px;
  font-weight:bold;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.buy{background:#1faa59;color:#fff}
.sell{background:#d64545;color:#fff}
</style>
</head>

<body>

<h3>BTC/USD Simulator (5s)</h3>

<div id="price"></div>
<div id="volume"></div>

<div id="controls">
  <button class="buy" onclick="trade('BUY')">BUY</button>
  <input id="amount" type="number" value="1000">
  <button class="sell" onclick="trade('SELL')">SELL</button>
</div>

<script>
/* ===== SETTINGS ===== */
const TIMEFRAME = 5000;
const LIQUIDITY = 1_000_000;

/* ===== STATE ===== */
let price = 30000;
let balanceUSD = 100000;
let balanceBTC = 0;

let currentCandle = null;
let currentNetVolume = 0;
let lastCandleTime = null;

/* ===== PRICE CHART ===== */
const priceEl = document.getElementById('price');
const priceChart = LightweightCharts.createChart(priceEl,{
  layout:{background:{color:'#111'},textColor:'#ccc'},
  grid:{vertLines:{color:'#222'},horzLines:{color:'#222'}},
  rightPriceScale:{visible:false},
  timeScale:{timeVisible:true,secondsVisible:false}
});

const candleSeries = priceChart.addCandlestickSeries({
  upColor:'#1faa59',
  downColor:'#d64545',
  borderUpColor:'#1faa59',
  borderDownColor:'#d64545',
  wickUpColor:'#1faa59',
  wickDownColor:'#d64545'
});

/* ===== VOLUME CHART ===== */
const volumeEl = document.getElementById('volume');
const volumeChart = LightweightCharts.createChart(volumeEl,{
  layout:{background:{color:'#111'},textColor:'#ccc'},
  grid:{vertLines:{color:'#222'},horzLines:{color:'#222'}},
  rightPriceScale:{visible:false},
  leftPriceScale:{visible:false},
  timeScale:{timeVisible:true,secondsVisible:false}
});

const volumeSeries = volumeChart.addHistogramSeries({
  base:0,
  priceFormat:{
    type:'custom',
    formatter:v => v.toFixed(2) + 'M'
  }
});

/* ===== SYNC ===== */
let syncing=false;
function sync(a,b){
  a.timeScale().subscribeVisibleLogicalRangeChange(r=>{
    if(syncing||!r) return;
    syncing=true;
    b.timeScale().setVisibleLogicalRange(r);
    syncing=false;
  });
}
sync(priceChart,volumeChart);
sync(volumeChart,priceChart);

/* ===== RESIZE ===== */
function resize(){
  priceChart.resize(priceEl.clientWidth,320);
  volumeChart.resize(volumeEl.clientWidth,100);
}
window.addEventListener('resize',resize);

/* ===== CANDLE LIFECYCLE ===== */
function startNewCandle(time){
  currentNetVolume = 0;

  currentCandle = {
    time,
    open: price,
    high: price,
    low: price,
    close: price
  };

  candleSeries.update(currentCandle);

  volumeSeries.update({
    time,
    value: 0,
    color: '#666'
  });
}

function ensureCandle(){
  const now = Math.floor(Date.now()/TIMEFRAME)*TIMEFRAME;

  if (!lastCandleTime) {
    startNewCandle(now/1000);
    lastCandleTime = now;
    return;
  }

  if (now > lastCandleTime) {
    /* finalize previous candle */
    candleSeries.update(currentCandle);
    volumeSeries.update({
      time: currentCandle.time,
      value: currentNetVolume / 1e6,
      color: currentNetVolume >= 0 ? '#1faa59' : '#d64545'
    });

    /* start new */
    startNewCandle(now/1000);
    lastCandleTime = now;
  }
}

/* ===== TRADES ===== */
function recordTrade(usd, side){
  const delta = usd / LIQUIDITY;

  if (side === 'BUY') {
    if (balanceUSD < usd) return;
    balanceUSD -= usd;
    balanceBTC += usd / price;
    price += delta;
    currentNetVolume += usd;
  } else {
    const btc = usd / price;
    if (balanceBTC < btc) return;
    balanceBTC -= btc;
    balanceUSD += usd;
    price -= delta;
    currentNetVolume -= usd;
  }

  currentCandle.high = Math.max(currentCandle.high, price);
  currentCandle.low  = Math.min(currentCandle.low, price);
  currentCandle.close = price;
}

/* ===== MANUAL ===== */
function trade(side){
  ensureCandle();
  recordTrade(+amount.value, side);
  candleSeries.update(currentCandle);
}

/* ===== CROWD ===== */
function crowd(){
  if (Math.random() < 0.6) return;
  recordTrade(50 + Math.random()*500, Math.random()>0.5 ? 'BUY' : 'SELL');
}

/* ===== LOOP ===== */
function tick(){
  ensureCandle();
  crowd();
  candleSeries.update(currentCandle);
}

/* ===== START ===== */
ensureCandle();
priceChart.timeScale().fitContent();
volumeChart.timeScale().fitContent();
resize();

setInterval(tick,300);
</script>

</body>
</html>
