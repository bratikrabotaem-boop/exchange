<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>BTC/USD Simulator (5s)</title>

<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
  body {
    margin: 0;
    background: #111;
    color: #ddd;
    font-family: Arial, sans-serif;
    text-align: center;
  }

  h3 {
    margin: 14px 0;
  }

  #chart {
    width: 100%;
    height: 420px;
    min-height: 420px;
  }

  #controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 14px;
    margin: 16px 0;
  }

  #amount {
    width: 120px;
    padding: 12px;
    font-size: 20px;
    text-align: center;
    border-radius: 8px;
    border: none;
  }

  button {
    padding: 14px 26px;
    font-size: 22px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }

  .buy { background:#1faa59; color:#fff }
  .sell { background:#d64545; color:#fff }

  #stats {
    font-size: 16px;
    margin-bottom: 12px;
  }
</style>
</head>

<body>

<h3>BTC/USD Simulator (5s)</h3>

<div id="chart"></div>

<div id="controls">
  <button class="buy" onclick="trade('BUY')">BUY</button>
  <input id="amount" type="number" value="1000">
  <button class="sell" onclick="trade('SELL')">SELL</button>
</div>

<div id="stats">
  USD: <span id="usd"></span> |
  BTC: <span id="btc"></span> |
  Price: <span id="price"></span>
</div>

<script>
/* ===== НАСТРОЙКИ ===== */
const TIMEFRAME = 5000;
const LIQUIDITY = 1_000_000;

/* ===== СОСТОЯНИЕ ===== */
let balanceUSD = 100000;
let balanceBTC = 0;
let price = 30000;
let lastPrice = price;

let currentCandle = null;
let lastCandleTime = null;

/* ===== ГРАФИК ===== */
const chartEl = document.getElementById('chart');

const chart = LightweightCharts.createChart(chartEl, {
  width: chartEl.clientWidth,
  height: 420,
  layout: { background: { color:'#111' }, textColor:'#ccc' },
  grid: { vertLines:{color:'#222'}, horzLines:{color:'#222'} }
});

const candleSeries = chart.addCandlestickSeries();

setTimeout(() => {
  chart.applyOptions({ width: chartEl.clientWidth, height: 420 });
}, 100);

window.addEventListener('resize', () => {
  chart.applyOptions({ width: chartEl.clientWidth });
});

/* ===== UI ===== */
const usdEl = document.getElementById('usd');
const btcEl = document.getElementById('btc');
const priceEl = document.getElementById('price');

function updateUI() {
  usdEl.textContent = balanceUSD.toFixed(2);
  btcEl.textContent = balanceBTC.toFixed(6);
  priceEl.textContent = price.toFixed(2);
}

/* ===== СВЕЧИ ===== */
function startNewCandle(time) {
  currentCandle = {
    time,
    open: price,
    high: price,
    low: price,
    close: price
  };
}

function ensureCandle() {
  const now = Math.floor(Date.now() / TIMEFRAME) * TIMEFRAME;
  if (!lastCandleTime || now > lastCandleTime) {
    startNewCandle(now / 1000);
    lastCandleTime = now;
  }
}

function updateCandle() {
  if (!currentCandle) return;
  candleSeries.update(currentCandle);
}

/* ===== СДЕЛКИ ===== */
function recordTrade(orderUsd, side) {
  if (!currentCandle) return;
  const delta = orderUsd / LIQUIDITY;

  if (side === 'BUY') {
    if (balanceUSD < orderUsd) return;
    balanceUSD -= orderUsd;
    balanceBTC += orderUsd / price;
    price += delta;
  } else {
    const btcAmount = orderUsd / price;
    if (balanceBTC < btcAmount) return;
    balanceBTC -= btcAmount;
    balanceUSD += orderUsd;
    price -= delta;
  }

  currentCandle.high = Math.max(currentCandle.high, price);
  currentCandle.low  = Math.min(currentCandle.low, price);
  currentCandle.close = price;
}

/* ===== РУЧНАЯ ТОРГОВЛЯ ===== */
function trade(side) {
  const orderUsd = Number(amount.value);
  if (!orderUsd || orderUsd <= 0) return;
  ensureCandle();
  recordTrade(orderUsd, side);
  updateCandle();
  updateUI();
}

/* ===== ТОЛПА ===== */
function randomCrowd() {
  if (Math.random() > 0.6) return;
  recordTrade(50 + Math.random()*300, Math.random()>0.5?'BUY':'SELL');
}

function reactiveCrowd() {
  const d = price - lastPrice;
  if (Math.abs(d) < 5) return;
  recordTrade(200 + Math.random()*800, d>0?'BUY':'SELL');
}

function momentumCrowd() {
  const body = currentCandle.close - currentCandle.open;
  if (Math.abs(body) < 10) return;
  recordTrade(500 + Math.random()*1500, body>0?'BUY':'SELL');
}

/* ===== РЫНОК ===== */
function marketTick() {
  ensureCandle();
  randomCrowd();
  reactiveCrowd();
  momentumCrowd();
  updateCandle();
  updateUI();
  lastPrice = price;
}

/* ===== СТАРТ ===== */
const startTime = Math.floor(Date.now() / TIMEFRAME) * TIMEFRAME;
startNewCandle(startTime / 1000);
lastCandleTime = startTime;
updateCandle();
updateUI();

setInterval(marketTick, 300);
</script>

</body>
</html>
