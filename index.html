<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Candle Simulator</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      background: #111;
      color: #ddd;
      font-family: Arial;
    }
    #chart {
      height: 500px;
    }
    #controls {
      margin-top: 10px;
    }
    input, button {
      padding: 6px;
      font-size: 14px;
      margin-right: 5px;
    }
  </style>
</head>
<body>

<h3>BTC/USD Simulator</h3>
<div id="chart"></div>

<div id="controls">
  <input id="amount" type="number" value="1000" />
  <button onclick="trade('BUY')">BUY</button>
  <button onclick="trade('SELL')">SELL</button>
</div>

<p>
  USD: <span id="usd"></span> |
  BTC: <span id="btc"></span> |
  Price: <span id="price"></span>
</p>

<script>
/* ====== НАСТРОЙКИ ====== */
const TIMEFRAME = 1000;        // 1 секунда
const LIQUIDITY = 1_000_000;  // чем больше — тем меньше движение цены

/* ====== СОСТОЯНИЕ ====== */
let balanceUSD = 100000;
let balanceBTC = 0;
let price = 30000;

let currentCandle = null;
let lastCandleTime = null;

/* ====== ГРАФИК ====== */
const chart = LightweightCharts.createChart(
  document.getElementById('chart'),
  { background: { color: '#111' }, textColor: '#ccc' }
);

const candleSeries = chart.addCandlestickSeries();
const volumeSeries = chart.addHistogramSeries({
  priceScaleId: '',
  priceFormat: { type: 'volume' },
  scaleMargins: { top: 0.8, bottom: 0 }
});

/* ====== ОБНОВЛЕНИЕ БАЛАНСА ====== */
function updateUI() {
  usd.textContent = balanceUSD.toFixed(2);
  btc.textContent = balanceBTC.toFixed(6);
  priceEl.textContent = price.toFixed(2);
}

const usd = document.getElementById('usd');
const btc = document.getElementById('btc');
const priceEl = document.getElementById('price');
updateUI();

/* ====== НОВАЯ СВЕЧА ====== */
function startNewCandle(time) {
  currentCandle = {
    time,
    open: price,
    high: price,
    low: price,
    close: price,
    buyUsd: 0,
    sellUsd: 0
  };
}

/* ====== ЗАПИСЬ СДЕЛКИ ====== */
function recordTrade(orderUsd, side) {
  const delta = orderUsd / LIQUIDITY;

  if (side === 'BUY') {
    balanceUSD -= orderUsd;
    balanceBTC += orderUsd / price;
    price += delta;
    currentCandle.buyUsd += orderUsd;
  } else {
    balanceBTC -= orderUsd / price;
    balanceUSD += orderUsd;
    price -= delta;
    currentCandle.sellUsd += orderUsd;
  }

  currentCandle.high = Math.max(currentCandle.high, price);
  currentCandle.low  = Math.min(currentCandle.low, price);
  currentCandle.close = price;
}

/* ====== BUY / SELL ====== */
function trade(side) {
  const orderUsd = Number(amount.value);
  if (!orderUsd || orderUsd <= 0) return;

  const now = Math.floor(Date.now() / TIMEFRAME) * TIMEFRAME;

  if (!lastCandleTime || now > lastCandleTime) {
    if (currentCandle) closeCandle();
    startNewCandle(now / 1000);
    lastCandleTime = now;
  }

  recordTrade(orderUsd, side);
  updateCandle();
  updateUI();
}

/* ====== ОБНОВЛЕНИЕ СВЕЧИ ====== */
function updateCandle() {
  candleSeries.update(currentCandle);

  const netVolume =
    currentCandle.buyUsd - currentCandle.sellUsd;

  volumeSeries.update({
    time: currentCandle.time,
    value: netVolume,
    color: netVolume >= 0 ? 'green' : 'red'
  });
}

/* ====== ЗАКРЫТИЕ СВЕЧИ ====== */
function closeCandle() {
  updateCandle();
}

/* ====== ПУСТЫЕ СВЕЧИ (КАК НА БИРЖЕ) ====== */
setInterval(() => {
  const now = Math.floor(Date.now() / TIMEFRAME) * TIMEFRAME;

  if (lastCandleTime && now > lastCandleTime) {
    startNewCandle(now / 1000);
    updateCandle();
    lastCandleTime = now;
  }
}, TIMEFRAME);
</script>

</body>
</html>
