<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Candle Simulator</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { background:#111; color:#ddd; font-family:Arial }
    #chart { height:500px }
    input, button { padding:6px; font-size:14px; margin-right:5px }
  </style>
</head>
<body>

<h3>BTC/USD Simulator (5s)</h3>
<div id="chart"></div>

<div>
  <input id="amount" type="number" value="1000">
  <button onclick="trade('BUY')">BUY</button>
  <button onclick="trade('SELL')">SELL</button>
</div>

<p>
  USD: <span id="usd"></span> |
  BTC: <span id="btc"></span> |
  Price: <span id="price"></span>
</p>

<script>
/* ===== НАСТРОЙКИ ===== */
const TIMEFRAME = 5000;        // 5 секунд
const LIQUIDITY = 1_000_000;

/* ===== СОСТОЯНИЕ ===== */
let balanceUSD = 100000;
let balanceBTC = 0;
let price = 30000;
let lastPrice = price;

let currentCandle = null;
let lastCandleTime = null;

/* ===== ГРАФИК ===== */
const chart = LightweightCharts.createChart(
  document.getElementById('chart'),
  { background:{color:'#111'}, textColor:'#ccc' }
);

const candleSeries = chart.addCandlestickSeries();
const volumeSeries = chart.addHistogramSeries({
  priceScaleId:'',
  priceFormat:{ type:'volume' },
  scaleMargins:{ top:0.8, bottom:0 }
});

/* ===== UI ===== */
const usd = document.getElementById('usd');
const btc = document.getElementById('btc');
const priceEl = document.getElementById('price');

function updateUI() {
  usd.textContent = balanceUSD.toFixed(2);
  btc.textContent = balanceBTC.toFixed(6);
  priceEl.textContent = price.toFixed(2);
}
updateUI();

/* ===== СВЕЧИ ===== */
function startNewCandle(time) {
  currentCandle = {
    time,
    open: price,
    high: price,
    low: price,
    close: price,
    buyUsd: 0,
    sellUsd: 0
  };
}

function updateCandle() {
  candleSeries.update(currentCandle);
  const net = currentCandle.buyUsd - currentCandle.sellUsd;
  volumeSeries.update({
    time: currentCandle.time,
    value: net,
    color: net >= 0 ? 'green' : 'red'
  });
}

/* ===== СДЕЛКИ ===== */
function recordTrade(orderUsd, side) {
  const delta = orderUsd / LIQUIDITY;

  if (side === 'BUY') {
    balanceUSD -= orderUsd;
    balanceBTC += orderUsd / price;
    price += delta;
    currentCandle.buyUsd += orderUsd;
  } else {
    balanceBTC -= orderUsd / price;
    balanceUSD += orderUsd;
    price -= delta;
    currentCandle.sellUsd += orderUsd;
  }

  currentCandle.high = Math.max(currentCandle.high, price);
  currentCandle.low  = Math.min(currentCandle.low, price);
  currentCandle.close = price;
}

/* ===== РУЧНАЯ ТОРГОВЛЯ ===== */
function trade(side) {
  const orderUsd = Number(amount.value);
  if (!orderUsd || orderUsd <= 0) return;

  ensureCandle();
  recordTrade(orderUsd, side);
  updateCandle();
  updateUI();
}

/* ===== ТОЛПА ===== */
function randomCrowd() {
  if (Math.random() > 0.6) return;
  recordTrade(50 + Math.random()*300, Math.random()>0.5?'BUY':'SELL');
}

function reactiveCrowd() {
  const d = price - lastPrice;
  if (Math.abs(d) < 5) return;
  recordTrade(200 + Math.random()*800, d>0?'BUY':'SELL');
}

function momentumCrowd() {
  const body = currentCandle.close - currentCandle.open;
  if (Math.abs(body) < 10) return;
  recordTrade(500 + Math.random()*1500, body>0?'BUY':'SELL');
}

/* ===== ТИК РЫНКА ===== */
function ensureCandle() {
  const now = Math.floor(Date.now()/TIMEFRAME)*TIMEFRAME;
  if (!lastCandleTime || now > lastCandleTime) {
    if (currentCandle) updateCandle();
    startNewCandle(now/1000);
    lastCandleTime = now;
  }
}

function marketTick() {
  ensureCandle();
  randomCrowd();
  reactiveCrowd();
  momentumCrowd();
  updateCandle();
  updateUI();
  lastPrice = price;
}

/* ===== ЗАПУСК ===== */
setInterval(marketTick, 300);
</script>

</body>
</html>
