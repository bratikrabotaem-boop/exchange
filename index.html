<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>BTC Simulator: Crowd PUMP Only</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    /* ===== СТИЛИ ===== */
    body {
        margin: 0; background: #121417; color: #e6e6e6;
        font-family: -apple-system, BlinkMacSystemFont, Roboto, Arial, sans-serif;
        overflow-y: auto; min-height: 100vh; padding-bottom: 40px;
        -webkit-tap-highlight-color: transparent;
    }
    .wrapper { max-width: 800px; margin: 0 auto; padding: 10px; box-sizing: border-box; }
    h3 { margin: 15px 0 5px 0; text-align: center; color: #fff; font-weight: 800; }
    .sub-title { text-align: center; font-size: 12px; color: #1fc77b; margin-bottom: 15px; } /* Зеленый подзаголовок */

    .stats-bar {
        display: flex; justify-content: space-between;
        background: #1e2228; padding: 10px 15px; border-radius: 8px;
        margin-bottom: 15px; border: 1px solid #1f2937; font-family: monospace; font-size: 14px;
    }
    .stat-val { font-weight: 700; color: #fff; }
    .stat-val.usd { color: #1fc77b; }

    .chart-box {
        width: 100%; border: 1px solid #1f2937; background: #121417;
        position: relative; border-radius: 8px; overflow: hidden; margin-bottom: 10px;
    }
    #price { width: 100%; height: 320px; }
    #volume { width: 100%; height: 160px; }

    #controls {
        display: flex; gap: 12px; margin-top: 20px;
        background: #1e2228; padding: 15px; border-radius: 12px; border: 1px solid #1f2937; 
    }
    #amount {
        width: 90px; padding: 12px; font-size: 16px; text-align: center;
        background: #121417; border: 1px solid #374151; color: #fff;
        border-radius: 8px; font-weight: 700; outline: none;
    }
    button {
        flex: 1; padding: 12px; font-size: 16px; font-weight: 800;
        border: none; border-radius: 8px; cursor: pointer; color: #fff;
        transition: transform 0.1s;
    }
    button:active { transform: scale(0.96); }
    .buy { background: #1fc77b; color: #052e16; box-shadow: 0 4px 0 #158f58; }
    .buy:active { box-shadow: 0 0 0 #158f58; transform: translateY(4px); }
    .sell { background: #e04b4b; color: #3f0808; box-shadow: 0 4px 0 #9e3333; }
    .sell:active { box-shadow: 0 0 0 #9e3333; transform: translateY(4px); }
</style>
</head>
<body>

<div class="wrapper">
    <h3>MARKET SIMULATOR</h3>
    <div class="sub-title">MODE: CROWD ONLY BUYS (UP ONLY)</div>

    <div class="stats-bar">
        <div>USD: <span class="stat-val usd" id="ui-usd">100,000</span></div>
        <div>BTC: <span class="stat-val" id="ui-btc">0.00</span></div>
    </div>

    <div class="chart-box"><div id="price"></div></div>
    <div class="chart-box"><div id="volume"></div></div>

    <div id="controls">
        <button class="buy" onclick="trade('BUY')">BUY</button>
        <input id="amount" type="number" value="10000" step="1000">
        <button class="sell" onclick="trade('SELL')">SELL</button>
    </div>
</div>

<script>
document.addEventListener('gesturestart', e => e.preventDefault());

/* ===== CONFIG ===== */
const TIMEFRAME = 15000;
const LIQUIDITY = 1_500_000; 

let price = 30000;
let balanceUSD = 100000;
let balanceBTC = 0;

let currentCandle = null;
let lastCandleTime = null;

let volBuy = 0;
let volSell = 0;

/* ===== CHARTS ===== */
const commonOpts = {
    layout: { background: { color: '#121417' }, textColor: '#9ca3af' },
    grid: { vertLines: { color: '#1f2937', style: 2 }, horzLines: { color: '#1f2937', style: 2 } },
    timeScale: { 
        timeVisible: true, secondsVisible: true, borderColor: '#1f2937',
        barSpacing: 10, minBarSpacing: 2, rightOffset: 10
    },
    handleScroll: { vertTouchDrag: false, horzTouchDrag: true },
};

const priceEl = document.getElementById('price');
const priceChart = LightweightCharts.createChart(priceEl, {
    ...commonOpts,
    rightPriceScale: { visible: true, borderColor: '#1f2937' },
});
const candleSeries = priceChart.addCandlestickSeries({
    upColor: '#1fc77b', downColor: '#e04b4b', borderUpColor: '#1fc77b', borderDownColor: '#e04b4b', wickUpColor: '#1fc77b', wickDownColor: '#e04b4b'
});

const volumeEl = document.getElementById('volume');
const volumeChart = LightweightCharts.createChart(volumeEl, {
    ...commonOpts,
    rightPriceScale: { visible: true, borderColor: '#1f2937' }, 
});
const volumeSeries = volumeChart.addHistogramSeries({
    priceFormat: { type: 'volume' }, priceScaleId: 'right',
});

function sync(a, b) {
    const s1 = a.timeScale(), s2 = b.timeScale();
    s1.subscribeVisibleLogicalRangeChange(r => { if(r) s2.setVisibleLogicalRange(r) });
    s2.subscribeVisibleLogicalRangeChange(r => { if(r) s1.setVisibleLogicalRange(r) });
}
sync(priceChart, volumeChart);

function resize() {
    if(priceEl.parentElement) {
        const w = priceEl.parentElement.offsetWidth;
        priceChart.resize(w, 320); volumeChart.resize(w, 160); 
    }
}
window.addEventListener('resize', resize);

const uiUsd = document.getElementById('ui-usd');
const uiBtc = document.getElementById('ui-btc');
function updateUI() {
    uiUsd.innerText = Math.floor(balanceUSD).toLocaleString('en-US');
    uiBtc.innerText = balanceBTC.toFixed(4);
}

/* ===== LOGIC ===== */
function startNewCandle(time){
    volBuy = 0; volSell = 0;
    currentCandle = {time, open:price, high:price, low:price, close:price};
    candleSeries.update(currentCandle);
    updateVolume(time);
}

function updateVolume(time) {
    const delta = volBuy - volSell;
    volumeSeries.update({
        time: time, value: delta, 
        color: delta >= 0 ? '#1fc77b' : '#e04b4b'
    });
}

function ensureCandle(){
    const now = Math.floor(Date.now()/TIMEFRAME)*TIMEFRAME;
    if(!lastCandleTime || now > lastCandleTime){
        startNewCandle(now/1000);
        lastCandleTime = now;
    }
}

function recordTrade(usd, side){
    const deltaPrice = usd / LIQUIDITY;
    if(side === 'BUY'){
        if(balanceUSD < usd) return;
        balanceUSD -= usd; balanceBTC += usd/price;
        price += deltaPrice * (0.8 + Math.random() * 0.4);
        volBuy += usd;
    } else {
        const btcNeeded = usd/price;
        if(balanceBTC < btcNeeded) return;
        balanceBTC -= btcNeeded; balanceUSD += usd;
        price -= deltaPrice * (0.8 + Math.random() * 0.4);
        volSell += usd;
    }
    currentCandle.high = Math.max(currentCandle.high, price);
    currentCandle.low = Math.min(currentCandle.low, price);
    currentCandle.close = price;
    candleSeries.update(currentCandle);
    updateVolume(currentCandle.time);
    updateUI();
}

function trade(side){
    ensureCandle();
    const val = parseFloat(document.getElementById('amount').value);
    if(val > 0) recordTrade(val, side);
}

/* === CROWD LOGIC (ONLY BUYS) === */
function crowd(){
    if(Math.random() < 0.2) return;
    
    const amt = 100 + Math.random() * 1500;
    
    // ИЗМЕНЕНИЕ: Всегда BUY
    const side = 'BUY'; 
    const deltaPrice = amt / LIQUIDITY;

    // Так как side всегда BUY, упрощаем логику
    price += deltaPrice;
    volBuy += amt;

    currentCandle.high = Math.max(currentCandle.high, price);
    currentCandle.low = Math.min(currentCandle.low, price);
    currentCandle.close = price;
    
    candleSeries.update(currentCandle);
    updateVolume(currentCandle.time);
}

/* INIT */
const start = Math.floor(Date.now()/TIMEFRAME)*TIMEFRAME;
startNewCandle(start/1000);
lastCandleTime = start;
updateUI();
resize();

setInterval(() => {
    ensureCandle();
    crowd();
}, 200);
</script>
</body>
</html>
